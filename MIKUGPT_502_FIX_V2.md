# MikuGPT 502 Bad Gateway Fix v2.0

## –ü—Ä–æ–±–ª–µ–º–∞
–ü–æ—Å—Ç–æ—è–Ω–Ω–æ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞: `502 Bad Gateway - Unable to reach the origin service. The service may be down or it may not be responding to traffic from cloudflared`

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –±—ç–∫–µ–Ω–¥ (Flask) –≤–µ—Ä–Ω—É–ª 500+ –æ—à–∏–±–∫—É –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ MikuGPT –∑–∞–ø—Ä–æ—Å–∞.

## –ü—Ä–∏—á–∏–Ω—ã
1. **g4f –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã** - –ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã AI –≤ g4f –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã
2. **–¢–∞–π–º–∞—É—Ç—ã** - –ó–∞–ø—Ä–æ—Å –∑–∞–Ω—è–ª —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ
3. **–°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏** - –ü—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º –∫ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—É
4. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–æ–≤** - –°–ª–∏—à–∫–æ–º –º–∞–ª–æ –ø–æ–ø—ã—Ç–æ–∫ retry

## –†–µ—à–µ–Ω–∏—è, —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤ v2.0

### 1. **–£–ª—É—á—à–µ–Ω–Ω–∞—è Retry –õ–æ–≥–∏–∫–∞**
```python
# –î–û: 2 –ø–æ–ø—ã—Ç–∫–∏, delay 1 —Å–µ–∫
self.max_retries = 2
self.retry_delay = 1

# –ü–û–°–õ–ï: 4 –ø–æ–ø—ã—Ç–∫–∏, delay 2 —Å–µ–∫ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff
self.max_retries = 4
self.retry_delay = 2
self.max_total_time = 120  # Max 2 minutes total
```

–≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff: 2s ‚Üí 4s ‚Üí 8s ‚Üí 16s

### 2. **–ë–æ–ª–µ–µ –ú–æ—â–Ω–∞—è –û–±—Ä–∞–±–æ—Ç–∫–∞ –û—à–∏–±–æ–∫**
- Retry –ø—Ä–∏ `ValueError` (–Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞)
- Retry –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö –æ—Ç–≤–µ—Ç–∞—Ö
- Timeout –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (2 –º–∏–Ω—É—Ç—ã –º–∞–∫—Å)
- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏

### 3. **–ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Fallback**
–§—É–Ω–∫—Ü–∏—è `generate_response()` **–í–°–ï–ì–î–ê** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π JSON:
- –ï—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí fallback –æ—Ç–≤–µ—Ç
- –ï—Å–ª–∏ —Ç–∞–π–º–∞—É—Ç ‚Üí fallback –æ—Ç–≤–µ—Ç  
- –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ ‚Üí fallback –æ—Ç–≤–µ—Ç
- **–ù–ò–ö–û–ì–î–ê** –Ω–µ –≤—ã–±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ

### 4. **HTTP –£—Ä–æ–≤–µ–Ω—å (–º–∞—Ä—à—Ä—É—Ç /api/miku/chat)**
- –í—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç HTTP 200 (–¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ)
- –ü–æ–ø—ã—Ç–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Üí fallback –æ—Ç–≤–µ—Ç —Å HTTP 200
- **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç 502 –æ—à–∏–±–∫–∏ –æ—Ç cloudflare**

### 5. **–ì–ª–æ–±–∞–ª—å–Ω—ã–µ –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –û—à–∏–±–æ–∫**
–î–æ–±–∞–≤–ª–µ–Ω—ã –≤ `app/__init__.py`:
```python
@app.errorhandler(500)  # Internal Server Error
@app.errorhandler(502)  # Bad Gateway
@app.errorhandler(503)  # Service Unavailable
```

–õ–æ–≥–∏—Ä—É—é—Ç –æ—à–∏–±–∫—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π JSON –æ—Ç–≤–µ—Ç.

## –ö–∞–∫ –†–∞–±–æ—Ç–∞–µ—Ç –ù–æ–≤–∞—è –°–∏—Å—Ç–µ–º–∞

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
```
–ü–æ–ø—ã—Ç–∫–∞ 1 ‚Üí ‚úÖ –£—Å–ø–µ—Ö ‚Üí –í–æ–∑–≤—Ä–∞—Ç –æ—Ç–≤–µ—Ç–∞ (1 —Å–µ–∫)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–µ—Ä–≤—ã–π —Ç–∞–π–º–∞—É—Ç, –≤—Ç–æ—Ä–æ–π —É—Å–ø–µ—Ö
```
–ü–æ–ø—ã—Ç–∫–∞ 1 ‚Üí ‚ùå –¢–∞–π–º–∞—É—Ç ‚Üí –û–∂–∏–¥–∞–Ω–∏–µ 2 —Å–µ–∫  
–ü–æ–ø—ã—Ç–∫–∞ 2 ‚Üí ‚úÖ –£—Å–ø–µ—Ö ‚Üí –í–æ–∑–≤—Ä–∞—Ç –æ—Ç–≤–µ—Ç–∞ (3 —Å–µ–∫)
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã
```
–ü–æ–ø—ã—Ç–∫–∞ 1 ‚Üí ‚ùå –û—à–∏–±–∫–∞ ‚Üí –û–∂–∏–¥–∞–Ω–∏–µ 2 —Å–µ–∫
–ü–æ–ø—ã—Ç–∫–∞ 2 ‚Üí ‚ùå –û—à–∏–±–∫–∞ ‚Üí –û–∂–∏–¥–∞–Ω–∏–µ 4 —Å–µ–∫
–ü–æ–ø—ã—Ç–∫–∞ 3 ‚Üí ‚ùå –û—à–∏–±–∫–∞ ‚Üí –û–∂–∏–¥–∞–Ω–∏–µ 8 —Å–µ–∫
–ü–æ–ø—ã—Ç–∫–∞ 4 ‚Üí ‚ùå –û—à–∏–±–∫–∞ ‚Üí –í—ã—Ö–æ–¥ –∏–∑ —Ü–∏–∫–ª–∞
Fallback –æ—Ç–≤–µ—Ç ‚Üí HTTP 200 ‚úÖ
```

–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –≤–µ–∂–ª–∏–≤—ã–π fallback –æ—Ç–≤–µ—Ç –≤–º–µ—Å—Ç–æ 502 –æ—à–∏–±–∫–∏!

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Flask –∑–∞–ø—É—â–µ–Ω
```bash
curl http://localhost:5000/api/health
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: {"status": "ok", "database": "ok", ...}
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å MikuGPT endpoint
```bash
curl -X POST http://localhost:5000/api/miku/chat \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"message": "–ü—Ä–∏–≤–µ—Ç –ú–∏–∫—É!"}'

# –û—Ç–≤–µ—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å:
# - –†–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç AI (–µ—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç)
# - Fallback –æ—Ç–≤–µ—Ç (–µ—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
# –í–°–ï–ì–î–ê HTTP 200 ‚úÖ
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥ —Ñ–∞–π–ª (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
tail -f app.log | grep MikuGPT

# –í–∏–¥–µ—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:
# - "MikuGPT request attempt 1/4"
# - "Transient error in MikuGPT (attempt 1): TimeoutError"
# - "Retrying after 2s..."
# - "MikuGPT response successful on attempt 2"
# –∏–ª–∏
# - "MikuGPT falling back to default response"
```

## –ß—Ç–æ –°–¥–µ–ª–∞—Ç—å –ï—Å–ª–∏ –í—Å–µ –ï—â–µ –í–∏–¥–∏—à—å 502?

### 1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ Flask –∑–∞–ø—É—â–µ–Ω**
```bash
ps aux | grep "python.*run.py"
# –ï—Å–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω:
python run.py
```

### 2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—Ç 5000**
```bash
netstat -a | grep 5000
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å: LISTENING –Ω–∞ 5000
```

### 3. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å cloudflare tunnel**
```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å cloudflared:
cloudflared tunnel run YOUR_TUNNEL_NAME

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å:
cloudflared tunnel ingress rule YOUR_TUNNEL_NAME
```

### 4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Flask**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å debug —Ä–µ–∂–∏–º–æ–º:
FLASK_ENV=development FLASK_DEBUG=1 python run.py

# –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å production –ª–æ–≥–∏:
tail -f /var/log/flask/app.log
```

### 5. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é cloudflare tunnel**
–£–±–µ–¥–∏—Å—å, —á—Ç–æ `~/.cloudflared/config.yml` —Å–æ–¥–µ—Ä–∂–∏—Ç:
```yaml
tunnel: YOUR_TUNNEL_ID
credentials-file: ~/.cloudflared/YOUR_TUNNEL_ID.json
ingress:
  - hostname: yourdomain.com
    service: http://localhost:5000
  - service: http_status:404
```

### 6. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É**
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ g4f –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º:
curl https://api.openai.com  # –ú–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
python -c "import g4f; print(g4f.Provider.get_model())"
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏
–û—Ç—Å–ª–µ–∂–∏–≤–∞–π –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ fallback –æ—Ç–≤–µ—Ç–æ–≤:
1. –ï—Å–ª–∏ > 50% fallback ‚Üí –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω—ã
2. –ï—Å–ª–∏ > 80% fallback ‚Üí –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏–ª–∏ —Å–µ—Ä–≤–∏—Å

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. **–î–æ–±–∞–≤–∏—Ç—å alerting** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–æ–≥–¥–∞ fallback ratio > 50%
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞** - –µ—Å–ª–∏ > 30 —Å–µ–∫, —É–≤–µ–ª–∏—á–∏—Ç—å timeout
3. **–†–æ—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤** - g4f –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –†–µ—à–µ–Ω–∏—è

–ï—Å–ª–∏ –∏ –¥–∞–ª—å—à–µ –ø—Ä–æ–±–ª–µ–º—ã —Å g4f:

### 1. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π API**
```python
# –í–º–µ—Å—Ç–æ g4f - OpenAI API
import openai
openai.api_key = "your-key"
response = openai.ChatCompletion.create(...)
```

### 2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–∏—Å**
- Claude API (Anthropic)
- Hugging Face Inference API
- Local –º–æ–¥–µ–ª—å (Ollama)

### 3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤**
```python
# –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥
CACHE_RESPONSES = True
CACHE_TTL = 3600  # 1 —á–∞—Å
```

## –†–µ–∑—é–º–µ –ò–∑–º–µ–Ω–µ–Ω–∏–π

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –î–æ | –ü–æ—Å–ª–µ |
|----------|----|----|
| Max Retries | 2 | 4 |
| Base Retry Delay | 1s | 2s |
| Max Total Time | ‚àû | 120s |
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ | –ë–∞–∑–æ–≤–∞—è | –ü–æ–ª–Ω–∞—è |
| HTTP —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –æ—à–∏–±–∫–µ | 500 | 200 |
| Fallback –æ—Ç–≤–µ—Ç | –ü—Ä–æ—Å—Ç–æ–π | –í–∞—Ä–∏–∞—Ç–∏–≤–Ω—ã–π |
| –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ | –î–µ—Ç–∞–ª—å–Ω–æ–µ |

## –ó–∞–ø—É—Å–∫ –∏ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# 1. –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
pip install -r requirements.txt

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å Flask
python run.py

# 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å MikuGPT
curl -X POST http://localhost:5000/api/miku/chat \
  -H "Authorization: Bearer TEST_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "message": "–ü—Ä–∏–≤–µ—Ç!",
    "personality": "–î–µ—Ä–µ–¥–µ—Ä–µ",
    "flirt_enabled": false,
    "nsfw_enabled": false
  }'

# 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏
tail -f flask.log | grep -i miku
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ
v2.0 –¥–æ–±–∞–≤–ª—è–µ—Ç:
‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö  
‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç (–Ω–∏–∫–æ–≥–¥–∞ 502)  
‚úÖ –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏  
‚úÖ –°–º–∞—Ä—Ç retry —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff  
‚úÖ Fallback –æ—Ç–≤–µ—Ç—ã –≤–º–µ—Å—Ç–æ –æ—à–∏–±–æ–∫  

–¢–µ–ø–µ—Ä—å MikuGPT –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞–º–Ω–æ–≥–æ –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–º! üéµ
